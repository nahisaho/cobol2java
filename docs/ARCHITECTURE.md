# COBOL2Java アーキテクチャ

## システム概要

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           COBOL2Java System                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────────┐     │
│   │   VS Code   │    │   Web App   │    │           CLI               │     │
│   │  Extension  │    │   (React)   │    │     (Commander.js)          │     │
│   └──────┬──────┘    └──────┬──────┘    └──────────────┬──────────────┘     │
│          │                  │                          │                     │
│          └──────────────────┼──────────────────────────┘                     │
│                             │                                                │
│                             ▼                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        @cobol2java/core                              │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │                     Public API Layer                         │    │   │
│   │  │  convert() | CobolParser | JavaGenerator | batchConvert()   │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   │                             │                                        │   │
│   │  ┌──────────────────────────┼──────────────────────────────────┐    │   │
│   │  │                   Core Modules                               │    │   │
│   │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ │    │   │
│   │  │  │ Parser  │→ │Transform│→ │Generator│→ │ Output Formatters│ │    │   │
│   │  │  └─────────┘  └─────────┘  └─────────┘  └─────────────────┘ │    │   │
│   │  │       ↓                                                      │    │   │
│   │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ │    │   │
│   │  │  │ Dialect │  │   LLM   │  │  Diff   │  │    Javadoc      │ │    │   │
│   │  │  │Detector │  │ Client  │  │ Report  │  │   Generator     │ │    │   │
│   │  │  └─────────┘  └─────────┘  └─────────┘  └─────────────────┘ │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. フロントエンド層

```
┌──────────────────────────────────────────────────────────────┐
│                     Frontend Layer                            │
├──────────────────┬──────────────────┬────────────────────────┤
│    VS Code       │     Web App      │         CLI            │
│   Extension      │                  │                        │
├──────────────────┼──────────────────┼────────────────────────┤
│ • COBOL構文      │ • Monaco Editor  │ • convert コマンド     │
│   ハイライト     │ • React 18       │ • batch コマンド       │
│ • 変換コマンド   │ • Tailwind CSS   │ • analyze コマンド     │
│ • ライブプレビュー│ • Vite           │ • ファイル監視         │
│ • ダイアレクト   │ • リアルタイム   │ • 進捗表示             │
│   検出           │   プレビュー     │                        │
└──────────────────┴──────────────────┴────────────────────────┘
```

### 2. コアライブラリ

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          @cobol2java/core                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                         Parser Module                               │ │
│  ├────────────────────────────────────────────────────────────────────┤ │
│  │                                                                     │ │
│  │   COBOL Source                                                      │ │
│  │        │                                                            │ │
│  │        ▼                                                            │ │
│  │   ┌─────────┐    ┌─────────────┐    ┌─────────────┐               │ │
│  │   │ Lexer   │ →  │   Parser    │ →  │    AST      │               │ │
│  │   │(Tokenize)│    │  (Grammar)  │    │ (CobolAst) │               │ │
│  │   └─────────┘    └─────────────┘    └─────────────┘               │ │
│  │                                            │                        │ │
│  │   Features:                                │                        │ │
│  │   • 4 DIVISION対応                        │                        │ │
│  │   • WORKING-STORAGE解析                   │                        │ │
│  │   • PIC句パース                           │                        │ │
│  │   • 段落/文解析                           ▼                        │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                               │                          │
│  ┌────────────────────────────────────────────┼───────────────────────┐ │
│  │                    Transform Module        │                        │ │
│  ├────────────────────────────────────────────┼───────────────────────┤ │
│  │                                            ▼                        │ │
│  │   ┌─────────────────────────────────────────────────────────────┐  │ │
│  │   │                   AST Transformers                          │  │ │
│  │   ├──────────────┬──────────────┬──────────────┬───────────────┤  │ │
│  │   │ Data Type    │  Statement   │  Control     │   String      │  │ │
│  │   │ Transformer  │ Transformer  │  Flow        │  Operations   │  │ │
│  │   ├──────────────┼──────────────┼──────────────┼───────────────┤  │ │
│  │   │ PIC→Java型  │ MOVE→代入   │ IF→if       │ STRING→concat│  │ │
│  │   │ COMP→int    │ ADD→+       │ PERFORM→call│ UNSTRING→split│  │ │
│  │   │ BINARY→long │ COMPUTE→式  │ EVALUATE→sw │ INSPECT→regex│  │ │
│  │   └──────────────┴──────────────┴──────────────┴───────────────┘  │ │
│  │                                            │                        │ │
│  └────────────────────────────────────────────┼───────────────────────┘ │
│                                               │                          │
│  ┌────────────────────────────────────────────┼───────────────────────┐ │
│  │                   Generator Module         │                        │ │
│  ├────────────────────────────────────────────┼───────────────────────┤ │
│  │                                            ▼                        │ │
│  │   ┌──────────────┐    ┌──────────────┐    ┌──────────────────────┐ │ │
│  │   │ Java Builder │ →  │ Code Emitter │ →  │   Generated Java     │ │ │
│  │   └──────────────┘    └──────────────┘    └──────────────────────┘ │ │
│  │                                                                     │ │
│  │   Output Modes:                                                     │ │
│  │   • Plain Java (POJO)                                               │ │
│  │   • Spring Boot (@Service, @Component)                              │ │
│  │   • Spring Batch (@StepScope, ItemProcessor)                        │ │
│  │                                                                     │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3. データフロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Data Flow                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   COBOL Source                                                           │
│   ┌────────────────────────────────────────┐                            │
│   │ IDENTIFICATION DIVISION.               │                            │
│   │ PROGRAM-ID. HELLO.                     │                            │
│   │ DATA DIVISION.                         │                            │
│   │ WORKING-STORAGE SECTION.               │                            │
│   │ 01 WS-NAME PIC X(20).                  │                            │
│   │ PROCEDURE DIVISION.                    │                            │
│   │     DISPLAY "HELLO".                   │                            │
│   │     STOP RUN.                          │                            │
│   └────────────────────────────────────────┘                            │
│                        │                                                 │
│                        ▼                                                 │
│   ┌────────────────────────────────────────┐                            │
│   │              CobolParser               │                            │
│   │  parser.parse(source) → CobolAst      │                            │
│   └────────────────────────────────────────┘                            │
│                        │                                                 │
│                        ▼                                                 │
│   CobolAst (Abstract Syntax Tree)                                        │
│   ┌────────────────────────────────────────┐                            │
│   │ {                                      │                            │
│   │   identificationDivision: {            │                            │
│   │     programId: "HELLO"                 │                            │
│   │   },                                   │                            │
│   │   dataDivision: {                      │                            │
│   │     workingStorage: {                  │                            │
│   │       items: [{ level: 1,              │                            │
│   │         name: "WS-NAME",               │                            │
│   │         picture: "X(20)" }]            │                            │
│   │     }                                  │                            │
│   │   },                                   │                            │
│   │   procedureDivision: { ... }           │                            │
│   │ }                                      │                            │
│   └────────────────────────────────────────┘                            │
│                        │                                                 │
│                        ▼                                                 │
│   ┌────────────────────────────────────────┐                            │
│   │             JavaGenerator              │                            │
│   │  generator.generate(ast) → Result     │                            │
│   └────────────────────────────────────────┘                            │
│                        │                                                 │
│                        ▼                                                 │
│   Java Output                                                            │
│   ┌────────────────────────────────────────┐                            │
│   │ package com.example;                   │                            │
│   │                                        │                            │
│   │ public class Hello {                   │                            │
│   │     private String wsName;             │                            │
│   │                                        │                            │
│   │     public void run() {                │                            │
│   │         System.out.println("HELLO");   │                            │
│   │     }                                  │                            │
│   │ }                                      │                            │
│   └────────────────────────────────────────┘                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4. パッケージ構造

```
cobol2java/
├── packages/
│   ├── core/                    # コアライブラリ
│   │   ├── src/
│   │   │   ├── parser.ts        # COBOLパーサー
│   │   │   ├── generator.ts     # Javaジェネレーター
│   │   │   ├── converter.ts     # 便利関数
│   │   │   ├── errors.ts        # エラー定義
│   │   │   ├── transform/       # AST変換
│   │   │   │   ├── data-types.ts
│   │   │   │   ├── statements.ts
│   │   │   │   ├── control-flow.ts
│   │   │   │   └── string-operations.ts
│   │   │   ├── dialect/         # ダイアレクト検出
│   │   │   ├── llm/             # LLM統合
│   │   │   ├── batch/           # バッチ変換
│   │   │   ├── diff/            # 差分レポート
│   │   │   └── javadoc/         # Javadoc生成
│   │   └── __tests__/           # テスト
│   │
│   ├── cli/                     # CLIツール
│   │   ├── src/
│   │   │   ├── index.ts         # エントリーポイント
│   │   │   └── commands/        # コマンド実装
│   │   └── __tests__/
│   │
│   ├── webapp/                  # Webアプリ
│   │   ├── src/
│   │   │   ├── App.tsx
│   │   │   ├── components/
│   │   │   └── hooks/
│   │   └── public/
│   │
│   └── vscode-extension/        # VS Code拡張
│       ├── src/
│       │   └── extension.ts
│       └── syntaxes/
│
├── docs/                        # ドキュメント
│   ├── USER_GUIDE.md
│   └── ARCHITECTURE.md
│
└── steering/                    # プロジェクトメモリ
    ├── product.ja.md
    ├── structure.ja.md
    └── tech.ja.md
```

### 5. 型マッピング

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    COBOL to Java Type Mapping                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   COBOL PIC Clause              Java Type                                │
│   ─────────────────────────────────────────────────────────────────     │
│   PIC 9(n)  (n≤4)         →    short                                    │
│   PIC 9(n)  (n≤9)         →    int                                      │
│   PIC 9(n)  (n≤18)        →    long                                     │
│   PIC 9(n)  (n>18)        →    BigInteger                               │
│   PIC 9(n)V9(m)           →    BigDecimal                               │
│   PIC S9(n)               →    int/long (signed)                        │
│   PIC X(n)                →    String                                   │
│   PIC A(n)                →    String                                   │
│   COMP / COMP-4           →    int / long                               │
│   COMP-1                  →    float                                    │
│   COMP-2                  →    double                                   │
│   COMP-3 / PACKED-DECIMAL →    BigDecimal                               │
│   88 level                →    boolean constant                         │
│                                                                          │
│   COBOL Structure               Java Structure                           │
│   ─────────────────────────────────────────────────────────────────     │
│   DIVISION                →    Class                                    │
│   SECTION                 →    Inner class / region                     │
│   Paragraph               →    Method                                   │
│   01 level item           →    Class / record                           │
│   Elementary item         →    Field                                    │
│   OCCURS clause           →    Array / List                             │
│   REDEFINES               →    Union pattern / multiple views           │
│   COPY                    →    Import / include                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6. Spring Boot/Batch 出力モード

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Output Mode Comparison                             │
├───────────────────┬───────────────────┬─────────────────────────────────┤
│     Plain Java    │    Spring Boot    │         Spring Batch            │
├───────────────────┼───────────────────┼─────────────────────────────────┤
│                   │                   │                                  │
│ public class X {  │ @Service          │ @Component                       │
│                   │ public class X {  │ @StepScope                       │
│   public void     │                   │ public class X                   │
│     run() {...}   │   public void     │   implements ItemProcessor {     │
│ }                 │     run() {...}   │                                  │
│                   │ }                 │   @Override                      │
│                   │                   │   public Y process(X x) {...}   │
│                   │                   │ }                                │
│                   │                   │                                  │
├───────────────────┼───────────────────┼─────────────────────────────────┤
│ Use cases:        │ Use cases:        │ Use cases:                       │
│ • Simple scripts  │ • REST APIs       │ • Batch processing               │
│ • Utilities       │ • Microservices   │ • ETL jobs                       │
│ • Libraries       │ • Web apps        │ • Scheduled tasks                │
└───────────────────┴───────────────────┴─────────────────────────────────┘
```

---

## パフォーマンス特性

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Performance Metrics                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   Operation              Small      Medium      Large       Very Large   │
│                         (10 items)  (50 items)  (100 items) (200 items) │
│   ────────────────────────────────────────────────────────────────────  │
│   Parse                   <5ms       <10ms       <20ms       <50ms      │
│   Transform               <2ms       <5ms        <10ms       <20ms      │
│   Generate                <10ms      <20ms       <50ms       <100ms     │
│   ────────────────────────────────────────────────────────────────────  │
│   Total                   <20ms      <50ms       <100ms      <200ms     │
│                                                                          │
│   Throughput: ~2,000+ conversions/second (small programs)                │
│   Memory: <10MB increase for 200-item programs                           │
│   Scaling: Linear O(n) with input size                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```
